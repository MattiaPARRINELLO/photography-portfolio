class UserActivityTracker { constructor() { this.userId = this.getUserId(), this.sessionStartTime = Date.now(), this.lastActivityTime = Date.now(), this.init() } getUserId() { const t = "user_tracking_id"; let e = this.getCookie(t); return e || (e = "user_" + this.generateRandomId(), this.setCookie(t, e, 365)), e } generateRandomId() { return Date.now().toString(36) + Math.random().toString(36).substr(2) } getCookie(t) { const e = `; ${document.cookie}`, i = e.split(`; ${t}=`); return 2 === i.length ? i.pop().split(";").shift() : null } setCookie(t, e, i) { const s = new Date; s.setTime(s.getTime() + 24 * i * 60 * 60 * 1e3), document.cookie = `${t}=${e};expires=${s.toUTCString()};path=/` } async logAction(t, e = {}) { try { const i = { userId: this.userId, action: t, timestamp: (new Date).toISOString(), url: window.location.href, page: window.location.pathname, sessionDuration: Date.now() - this.sessionStartTime, timeSinceLastActivity: Date.now() - this.lastActivityTime, ...e }; window.campaignInfo && (i.campaignInfo = window.campaignInfo), await fetch("/log-action", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(i) }), this.lastActivityTime = Date.now() } catch (t) { console.error("âŒ Erreur lors de l'envoi du log:", t) } } extractSourceParams() { const t = new URLSearchParams(window.location.search), e = {}, i = ["source", "utm_source", "utm_medium", "utm_campaign", "utm_term", "utm_content", "ref", "referrer", "origin"]; return i.forEach(i => { t.has(i) && (e[i] = t.get(i)) }), Object.keys(e).length > 0 && sessionStorage.setItem("traffic_source", JSON.stringify(e)), e } getTrafficSource() { const t = this.extractSourceParams(); if (Object.keys(t).length > 0) return t; const e = sessionStorage.getItem("traffic_source"); if (e) try { return JSON.parse(e) } catch (t) { console.warn("Erreur lors de la lecture de la source de trafic:", t) } return null } init() { const t = this.getTrafficSource(); this.logAction("page_visit", { referrer: document.referrer, userAgent: navigator.userAgent, screenResolution: `${screen.width}x${screen.height}`, viewport: `${window.innerWidth}x${window.innerHeight}`, trafficSource: t }), this.trackClicks(), this.trackPageNavigation(), this.trackScrolling(), this.trackFormInteractions(), this.trackPhotoInteractions(), this.trackTimeSpent() } trackClicks() { document.addEventListener("click", t => { const e = t.target, i = e.tagName.toLowerCase(), s = e.className, o = e.id, n = e.textContent?.substring(0, 100) || ""; let r = "click", a = { element: i, className: s, id: o, text: n.trim(), position: { x: t.clientX, y: t.clientY } }; if ("button" === i) r = "button_click"; else if ("a" === i) r = "link_click", a.href = e.href; else if ("img" === i) { if (e.src && (e.src.includes("/photos/") || e.src.match(/\.(jpg|jpeg|png|webp)$/i))) return; r = "image_click", a.src = e.src, a.alt = e.alt } else if (e.closest(".photo-item")) { r = "photo_click"; const t = e.closest(".photo-item").querySelector("img"); a.photoSrc = t?.src, a.photoAlt = t?.alt } this.logAction(r, a) }) } trackPageNavigation() { document.addEventListener("visibilitychange", () => { document.hidden ? this.logAction("page_hide") : this.logAction("page_show") }), window.addEventListener("beforeunload", () => { this.logAction("page_leave", { timeSpent: Date.now() - this.sessionStartTime }) }) } trackScrolling() { let t = null, e = 0; window.addEventListener("scroll", () => { clearTimeout(t); const i = Math.round(window.scrollY / (document.documentElement.scrollHeight - window.innerHeight) * 100); i > e && (e = i), t = setTimeout(() => { this.logAction("scroll", { scrollPercent: i, maxScrollPercent: e, scrollY: window.scrollY }) }, 1e3) }) } trackFormInteractions() { document.addEventListener("submit", t => { const e = t.target; this.logAction("form_submit", { formId: e.id, formClass: e.className, action: e.action || window.location.href }) }), document.addEventListener("input", t => { const e = t.target; "search" === e.type && this.logAction("search_input", { searchTerm: e.value.substring(0, 50), inputId: e.id }) }) } trackPhotoInteractions() { if ("IntersectionObserver" in window) { const t = new IntersectionObserver(t => { t.forEach(t => { if (t.isIntersecting) { const e = t.target; this.logAction("photo_view", { photoSrc: e.src, photoAlt: e.alt, viewportPosition: t.intersectionRatio }) } }) }, { threshold: .5 }); document.querySelectorAll("img").forEach(e => { t.observe(e) }); new MutationObserver(e => { e.forEach(e => { e.addedNodes.forEach(e => { if (1 === e.nodeType) { e.querySelectorAll("img").forEach(e => t.observe(e)) } }) }) }).observe(document.body, { childList: !0, subtree: !0 }) } this.trackPhotoClicks() } trackPhotoClicks() { const t = async (t, e) => { try { const i = new URL(e, window.location.origin).pathname.split("/").pop(), s = { userId: this.userId, photoFilename: i, photoFullUrl: e, clickPosition: this.getElementPosition(t), timestamp: (new Date).toISOString(), page: window.location.pathname, userAgent: navigator.userAgent, screenSize: `${screen.width}x${screen.height}`, viewportSize: `${window.innerWidth}x${window.innerHeight}` }; (await fetch("/photo-click", { method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(s) })).ok ? console.log(`ğŸ“¸ Clic photo enregistrÃ©: ${i}`) : console.warn("âš ï¸ Erreur lors de l'enregistrement du clic photo") } catch (t) { console.error("âŒ Erreur lors de l'enregistrement du clic photo:", t) } }, e = () => { document.querySelectorAll("img").forEach(e => { e.hasAttribute("data-click-tracked") || (e.setAttribute("data-click-tracked", "true"), e.addEventListener("click", i => { const s = e.src; s && (s.includes("/photos/") || s.match(/\.(jpg|jpeg|png|webp)$/i)) && (t(e, s), this.logAction("photo_click", { photoSrc: s, photoAlt: e.alt, photoFilename: s.split("/").pop() })) })) }) }; e(), new MutationObserver(i => { i.forEach(i => { i.addedNodes.forEach(i => { if (1 === i.nodeType) { if ("IMG" === i.tagName && !i.hasAttribute("data-click-tracked")) { i.setAttribute("data-click-tracked", "true"), i.addEventListener("click", e => { const s = i.src; s && (s.includes("/photos/") || s.match(/\.(jpg|jpeg|png|webp)$/i)) && (t(i, s), this.logAction("photo_click", { photoSrc: s, photoAlt: i.alt, photoFilename: s.split("/").pop() })) }) } i.querySelectorAll("img").forEach(i => { i.hasAttribute("data-click-tracked") || (i.setAttribute("data-click-tracked", "true"), i.addEventListener("click", e => { const s = i.src; s && (s.includes("/photos/") || s.match(/\.(jpg|jpeg|png|webp)$/i)) && (t(i, s), this.logAction("photo_click", { photoSrc: s, photoAlt: i.alt, photoFilename: s.split("/").pop() })) })) }) } }) }) }).observe(document.body, { childList: !0, subtree: !0 }) } getElementPosition(t) { const e = t.getBoundingClientRect(); return { x: e.left + window.scrollX, y: e.top + window.scrollY, width: e.width, height: e.height, viewportX: e.left, viewportY: e.top } } trackTimeSpent() { setInterval(() => { document.hidden || this.logAction("heartbeat", { timeSpent: Date.now() - this.sessionStartTime, activeTime: Date.now() - this.lastActivityTime }) }, 3e4) } } document.addEventListener("DOMContentLoaded", () => { window.userTracker = new UserActivityTracker, console.log("ğŸ” User Activity Tracker initialisÃ©") }), "undefined" != typeof module && module.exports && (module.exports = UserActivityTracker);
