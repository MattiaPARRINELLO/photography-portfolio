<!DOCTYPE html>
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- META_PLACEHOLDER_START -->
    <title>{{DYNAMIC_TITLE}}</title>
    <meta name="description" content="{{DYNAMIC_DESCRIPTION}}" />
    <!-- META_PLACEHOLDER_END -->
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="../dist/assets/Logo_MP.svg" />
    <link rel="stylesheet" href="../dist/css/output.css" />
    <!-- Alpine.js -->
    <script
      defer
      src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"
    ></script>
    <!-- Start - Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous" />
    <link
      href="https://fonts.googleapis.com/css2?family=Signika:wght@400;700&display=swap"
      rel="stylesheet"
      media="print" onload="this.media='all'"
    />
    <noscript>
      <link
        href="https://fonts.googleapis.com/css2?family=Signika:wght@400;700&display=swap"
        rel="stylesheet"
      />
    </noscript>
    <!-- End - Fonts -->
    <!-- Start - Fancybox Scripts -->
    <script defer src="https://cdn.jsdelivr.net/npm/exifr/dist/full.umd.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"></script>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css"
      media="print" onload="this.media='all'"
    />
    <!-- End - Fancybox Scripts -->
    <!-- Masonry.js -->
    <script defer src="https://unpkg.com/masonry-layout@4/dist/masonry.pkgd.min.js"></script>
    <script defer src="https://unpkg.com/imagesloaded@5/imagesloaded.pkgd.min.js"></script>
    <!-- End - Masonry.js -->
    <style>
      /* Subtle animated background used across public pages */
      .animated-bg{
        position:fixed;
        inset:0;
        z-index:0; /* above page background so blobs are visible */
        pointer-events:none;
        overflow:hidden;
        background: linear-gradient(180deg, rgba(0,0,0,0.02), rgba(0,0,0,0.04));
      }
      .animated-bg .blob{
        position:absolute;
        width:50vmax;
        height:50vmax;
        border-radius:50%;
        filter: blur(36px);
        opacity:0.22;
        transform: translate3d(0,0,0) scale(1);
        will-change: transform, opacity;
        mix-blend-mode: screen;
      }
      /* positions and color variations for 7 blobs */
      .animated-bg .blob.b1{ left:-12%; top:-20%; background:radial-gradient(circle at 30% 30%, rgba(102,126,234,0.98), rgba(102,126,234,0.22)); }
      .animated-bg .blob.b2{ right:-14%; bottom:-12%; background:radial-gradient(circle at 70% 70%, rgba(139,69,19,0.96), rgba(139,69,19,0.18)); }
      .animated-bg .blob.b3{ left:52%; top:62%; transform:translateX(-50%); background:radial-gradient(circle at 50% 50%, rgba(75,0,130,0.95), rgba(75,0,130,0.16)); }
      .animated-bg .blob.b4{ left:20%; top:60%; background:radial-gradient(circle at 40% 50%, rgba(66,153,225,0.9), rgba(66,153,225,0.12)); opacity:0.14; }
      .animated-bg .blob.b5{ right:30%; top:10%; background:radial-gradient(circle at 50% 40%, rgba(236,72,153,0.9), rgba(236,72,153,0.12)); opacity:0.12; }
      .animated-bg .blob.b6{ left:5%; bottom:10%; background:radial-gradient(circle at 20% 80%, rgba(250,204,21,0.88), rgba(250,204,21,0.10)); opacity:0.11; }
      .animated-bg .blob.b7{ right:5%; top:40%; background:radial-gradient(circle at 60% 30%, rgba(16,185,129,0.9), rgba(16,185,129,0.10)); opacity:0.12; }
      /* Light-mode stronger/darker blobs */
      @media (prefers-color-scheme: light) {
        .animated-bg .blob{ mix-blend-mode: multiply; opacity: 0.36; filter: blur(28px); }
        .animated-bg .blob.b1{ background:radial-gradient(circle at 30% 30%, rgba(32,78,200,0.95), rgba(32,78,200,0.32)); }
        .animated-bg .blob.b2{ background:radial-gradient(circle at 70% 70%, rgba(120,50,20,0.96), rgba(120,50,20,0.3)); }
        .animated-bg .blob.b3{ background:radial-gradient(circle at 50% 50%, rgba(60,10,120,0.95), rgba(60,10,120,0.28)); }
        .animated-bg .blob.b4{ background:radial-gradient(circle at 40% 50%, rgba(40,110,200,0.92), rgba(40,110,200,0.26)); }
        .animated-bg .blob.b5{ background:radial-gradient(circle at 50% 40%, rgba(200,40,120,0.92), rgba(200,40,120,0.26)); }
        .animated-bg .blob.b6{ background:radial-gradient(circle at 20% 80%, rgba(200,150,20,0.9), rgba(200,150,20,0.22)); }
        .animated-bg .blob.b7{ background:radial-gradient(circle at 60% 30%, rgba(10,140,90,0.9), rgba(10,140,90,0.22)); }
      }
      @keyframes blobMove{
        0%{ transform: translate3d(0,0,0) scale(1); }
        25%{ transform: translate3d(5%, -3%, 0) scale(1.05); }
        50%{ transform: translate3d(0,5%,0) scale(1); }
        75%{ transform: translate3d(-4%,-2%,0) scale(0.98); }
        100%{ transform: translate3d(0,0,0) scale(1); }
      }
      @media (prefers-reduced-motion: reduce){ .animated-bg .blob{ animation: none !important; } }
    </style>
    <script defer>
      // Protection et logs conditionnels
      const isProduction = !window.location.hostname.match(/localhost|127\.0\.0\.1/);
      const devLog = isProduction ? function(){} : console.log.bind(console);
      const devWarn = isProduction ? function(){} : console.warn.bind(console);
      const devError = isProduction ? function(){} : console.error.bind(console);
      
      if (isProduction) {
        console.log('%c\n' +
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n' +
          '‚ïë                                                                 ‚ïë\n' +
          '‚ïë               ‚ö†Ô∏è  AVERTISSEMENT DE S√âCURIT√â  ‚ö†Ô∏è                ‚ïë\n' +
          '‚ïë                                                                 ‚ïë\n' +
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê',
          'color: #ff3333; font-size: 16px; font-weight: bold; font-family: monospace; line-height: 1.5;'
        );
        
        console.log('%c\nüö´ ACC√àS NON AUTORIS√â √Ä LA CONSOLE DE D√âVELOPPEMENT üö´\n',
          'color: #ff6600; font-size: 22px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); background: linear-gradient(90deg, #330000, #000000); padding: 15px 20px; border-radius: 5px;'
        );
        
        console.log(
          '%c‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\n' +
          '‚îÇ  Vous tentez d\'acc√©der aux photos de ce site ?            ‚îÇ\n' +
          '‚îÇ                                                            ‚îÇ\n' +
          '‚îÇ  ‚ùå T√âL√âCHARGEMENT INTERDIT                                ‚îÇ\n' +
          '‚îÇ  ‚ùå COPIE INTERDITE                                        ‚îÇ\n' +
          '‚îÇ  ‚ùå UTILISATION NON AUTORIS√âE INTERDITE                    ‚îÇ\n' +
          '‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò',
          'color: #ffff00; font-size: 15px; font-weight: bold; font-family: monospace; line-height: 1.8; background: #1a1a1a; padding: 20px; border-left: 5px solid #ff0000;'
        );
        
        console.log(
          '%c\nüì∏ PROTECTION DU DROIT D\'AUTEUR\n',
          'color: #00ffff; font-size: 18px; font-weight: bold; text-decoration: underline;'
        );
        
        console.log(
          '%c¬© Mattia Parrinello - Tous droits r√©serv√©s\n\n' +
          'Toutes les photographies publi√©es sur ce site sont prot√©g√©es par le droit d\'auteur.\n' +
          'Toute reproduction, repr√©sentation, modification, publication, transmission,\n' +
          'd√©naturation, totale ou partielle du site ou de son contenu, par quelque\n' +
          'proc√©d√© que ce soit, sans autorisation √©crite pr√©alable est interdite et\n' +
          'constitue un d√©lit de contrefa√ßon sanctionn√© par les articles L.335-2 et\n' +
          'suivants du Code de la propri√©t√© intellectuelle.\n',
          'color: #ffffff; font-size: 14px; line-height: 1.6; background: #1a1a1a; padding: 15px; border-left: 4px solid #00ff00;'
        );
        
        console.log(
          '%c‚öñÔ∏è  SANCTIONS P√âNALES\n',
          'color: #ff6666; font-size: 16px; font-weight: bold; text-decoration: underline;'
        );
        
        console.log(
          '%cLa contrefa√ßon est punie de :\n' +
          '‚Ä¢ 300 000 ‚Ç¨ d\'amende\n' +
          '‚Ä¢ 3 ans d\'emprisonnement\n' +
          '(Articles L.335-2 et suivants du Code de la propri√©t√© intellectuelle)\n',
          'color: #ff9999; font-size: 13px; line-height: 1.8; font-weight: bold; background: #2a0000; padding: 15px; border-left: 4px solid #ff0000;'
        );
        
        console.log(
          '%cüìã Pour toute demande d\'utilisation l√©gitime :\n' +
            '‚Üí Utilisez le formulaire de contact : ' + window.location.origin + '/contact\n' +
        );
        
        console.log('%c\n' +
          '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n',
          'color: #ff3333; font-size: 16px; font-weight: bold; font-family: monospace;'
        );
      }

      // Start fetching photos list immediately to improve LCP (fallback if not injected)
      const photosListPromise = window.INJECTED_PHOTOS 
        ? Promise.resolve(window.INJECTED_PHOTOS) 
        : fetch('/photos-list').then(res => res.json()).catch(err => []);

      // Masonry instance holder
      let masonryInstance = null;

      // Skeleton helpers (show/remove placeholders while loading)
      function showSkeleton(container, count = 12) {
        // If we have server-rendered items, don't show skeleton!
        if (container.children.length > 0 && !container.querySelector('.skeleton-grid')) {
             return;
        }
        const sk = document.createElement('div');
        sk.className = 'skeleton-grid';
        for (let i = 0; i < count; i++) {
          const it = document.createElement('div');
          it.className = 'skeleton-item';
          sk.appendChild(it);
        }
        container.appendChild(sk);
      }

      function removeSkeletons(container) {
        const sk = container.querySelector('.skeleton-grid');
        if (sk) sk.remove();
      }

      // Fonction pour charger les images et initialiser la grille justifi√©e
      async function loadGallery() {
        const gallery = document.getElementById('gallery');
        
        // Check if we have server-rendered items
        const hasServerItems = gallery.children.length > 0;

        // Show skeleton placeholders immediately while fetching and loading
        if (!hasServerItems) {
          showSkeleton(gallery, 12);
        }

        const photos = await photosListPromise;

        // Skeleton will be removed once the first real thumbnail finishes loading

        const galleryItems = [];
        
        // If we have server items, we need to rebuild galleryItems array for Fancybox
        // and attach event listeners to existing items
        if (hasServerItems) {
            const existingItems = Array.from(gallery.querySelectorAll('.gallery-item'));
            existingItems.forEach((div, index) => {
                const a = div.querySelector('a');
                const img = div.querySelector('img');
                if (a && img) {
                   // Reconstruct photo object from attributes
                   const photoUrl = a.getAttribute('data-original');
                   const photoFilename = a.getAttribute('data-file');
                   
                   // Add to galleryItems for Fancybox
                   galleryItems.push({ src: a.href, type: 'image', thumb: img.src, caption: '', original: photoUrl });
                   
                   // Attach click listener
                   const itemIndex = index;
                   a.addEventListener('click', (e) => {
                      e.preventDefault();
                      e.stopPropagation();
                      openFancybox(itemIndex);
                   });
                   
                   // EXIF display disabled: attachExifLoader removed to prevent EXIF caption on click
                   // attachExifLoader(img, photoUrl, a, itemIndex);
                }
            });
        }

        // Helper to open Fancybox (extracted to avoid duplication)
        function openFancybox(startIndex) {
            try {
                if (window.Fancybox) {
                  Fancybox.show(galleryItems, {
                    startIndex: startIndex,
                    on: {
                      reveal: (fancybox, slide) => {
                          handleFancyboxReveal(slide);
                      }
                    }
                  });
                } else {
                  window.open(galleryItems[startIndex].src, '_blank');
                }
            } catch (err) {
                devError('Fancybox show failed', err);
            }
        }

        // Helper for Fancybox reveal logic (extracted)
        function handleFancyboxReveal(slide) {
            // Debug: log slide structure once per slide index to help find where the original URL is stored
            try {
              try {
                window.__fb_logged_slides = window.__fb_logged_slides || new Set();
                const sidx = slide && (typeof slide.index !== 'undefined' ? slide.index : (slide && slide.$index));
                if (!window.__fb_logged_slides.has(sidx)) {
                  window.__fb_logged_slides.add(sidx);
                  devDebug('Fancybox: reveal called for slide', sidx, ' ‚Äî dumping slide object once');
                  try { console.dir && console.dir(slide); } catch (e) { devDebug('Fancybox: cannot dir slide', e); }
                }
              } catch (e) {}
              const original = (slide && slide.$trigger && slide.$trigger.dataset && slide.$trigger.dataset.original)
                || (slide && slide.item && slide.item.original)
                || (slide && slide.original)
                || (typeof galleryItems !== 'undefined' && galleryItems[slide && slide.index] && galleryItems[slide.index].original);
              if (!original) {
                devDebug('Fancybox: original HD url not found for slide', slide && slide.index, slide);
                return;
              }

              let highLoaded = false;

              // Resolve slide content element once and reuse
              const container = (slide && (slide.$content || slide.contentEl || (slide.content && slide.content.el) || slide.html)) || null;
              if (!container) {
                devDebug('Fancybox: no slide content element for HD bindings', slide && slide.index);
                return;
              }

              const imgEl = () => {
                try {
                  if (container && container.querySelector) return container.querySelector('img');
                  if (slide && slide.imageEl) return slide.imageEl;
                  if (slide && slide.image && slide.image.el) return slide.image.el.querySelector('img');
                } catch (e) {}
                return null;
              };

              function loadHighRes() {
                if (highLoaded) return;
                const target = imgEl();
                if (!target) return;

                // If an HD request button exists in the slide, hide it immediately
                try {
                  const existingHdBtn = container.querySelector('.hd-request-btn');
                  if (existingHdBtn) {
                    existingHdBtn.style.display = 'none';
                  }
                } catch (e) { /* ignore */ }

                // Create / show loading badge (but animate icon -> badge first when possible)
                function createNotice() {
                  let notice = container.querySelector('.hd-loading');
                  if (!notice) {
                    notice = document.createElement('div');
                    notice.className = 'hd-loading';
                    // styling: small semi-transparent badge (moved to top-left)
                    notice.style.position = 'absolute';
                    notice.style.top = '8px';
                    notice.style.left = '8px';
                    notice.style.padding = '6px 8px';
                    notice.style.background = 'rgba(0,0,0,0.6)';
                    notice.style.color = '#fff';
                    notice.style.borderRadius = '6px';
                    notice.style.fontSize = '12px';
                    notice.style.zIndex = '9999';
                    // Include a small SVG icon (clone from HD button if available) for a consistent look
                    try {
                      // ensure badge contents stay on one line
                      notice.style.display = 'inline-flex';
                      notice.style.alignItems = 'center';
                      notice.style.gap = '8px';
                      notice.style.whiteSpace = 'nowrap';

                      const hdBtn = container.querySelector('.hd-request-btn');
                      let svgClone = null;
                      if (hdBtn) {
                        const s = hdBtn.querySelector && hdBtn.querySelector('svg');
                        if (s) svgClone = s.cloneNode(true);
                      }
                      if (svgClone) {
                        svgClone.style.width = '14px';
                        svgClone.style.height = '14px';
                        svgClone.style.display = 'inline-block';
                        svgClone.style.marginRight = '8px';
                        svgClone.style.opacity = '0.95';
                        svgClone.style.verticalAlign = 'middle';
                        notice.appendChild(svgClone);
                      }
                    } catch (e) {
                      // ignore svg clone errors
                    }
                    const span = document.createElement('span');
                    span.textContent = 'Chargement HD...';
                    span.style.display = 'inline-block';
                    span.style.lineHeight = '1';
                    span.style.whiteSpace = 'nowrap';
                    notice.appendChild(span);
                    try { container.appendChild(notice); } catch (e) { /* ignore */ }
                  }
                  return notice;
                }

                // Try to animate the HD icon into the small badge for a nicer transition.
                function animateIconToBadge() {
                  return new Promise((resolve) => {
                    try {
                      // Respect reduced motion
                      if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                        return resolve();
                      }

                      const hdBtn = container.querySelector('.hd-request-btn');
                      const containerRect = container.getBoundingClientRect();
                      if (!containerRect) return resolve();

                      let startRect = null;
                      if (hdBtn) {
                        const r = hdBtn.getBoundingClientRect();
                        if (r && r.width > 2 && r.height > 2) startRect = r;
                      }
                      if (!startRect) {
                        startRect = { left: containerRect.left + 12, top: containerRect.top + 12, width: 36, height: 36 };
                      }

                      // target (top-left badge) - align with badge left:8px inside container
                      const targetLeft = containerRect.left + 8;
                      const targetTop = containerRect.top + 8;
                      const targetWidth = 140; // wider to fit the text during morph
                      const targetHeight = 28;

                      // Build a morphing clone: a pill that contains the svg and a hidden text span
                      const wrap = document.createElement('div');
                      wrap.className = 'hd-anim-clone';
                      wrap.style.position = 'fixed';
                      wrap.style.left = startRect.left + 'px';
                      wrap.style.top = startRect.top + 'px';
                      wrap.style.width = startRect.width + 'px';
                      wrap.style.height = startRect.height + 'px';
                      wrap.style.padding = '6px';
                      wrap.style.display = 'inline-flex';
                      wrap.style.alignItems = 'center';
                      wrap.style.justifyContent = 'center';
                      wrap.style.borderRadius = Math.max(6, startRect.height/2) + 'px';
                      wrap.style.background = 'transparent';
                      wrap.style.overflow = 'hidden';
                      wrap.style.boxSizing = 'border-box';
                      // disable transition initially to avoid abrupt start
                      wrap.style.transition = 'none';
                      wrap.style.willChange = 'transform, width, height, border-radius, background, opacity';

                      // inner svg
                      let svgEl = null;
                      // compute sizes: keep starting svg size consistent and animate scale
                      const startSvgSize = Math.max(12, Math.min(startRect.height - 6, startRect.width - 6));
                      const targetSvgSize = 14;
                      try {
                        if (hdBtn) {
                          const s = hdBtn.querySelector && hdBtn.querySelector('svg');
                          if (s) svgEl = s.cloneNode(true);
                        }
                      } catch (e) { svgEl = null; }
                      if (svgEl) {
                        svgEl.style.width = startSvgSize + 'px';
                        svgEl.style.height = startSvgSize + 'px';
                        svgEl.style.transform = 'scale(1)';
                        svgEl.style.transition = 'transform 520ms cubic-bezier(.2,.9,.2,1), opacity 260ms ease';
                        svgEl.style.opacity = '1';
                        wrap.appendChild(svgEl);
                      }

                      // text that will appear (initially hidden)
                      const text = document.createElement('span');
                      text.textContent = 'Chargement HD...';
                      text.style.color = '#fff';
                      text.style.fontSize = '12px';
                      text.style.marginLeft = svgEl ? '8px' : '6px';
                      text.style.opacity = '0';
                      text.style.whiteSpace = 'nowrap';
                      text.style.transition = 'opacity 260ms ease 220ms';
                      wrap.appendChild(text);

                      document.body.appendChild(wrap);
                      // Force layout
                      wrap.getBoundingClientRect();

                      const deltaX = targetLeft - startRect.left;
                      const deltaY = targetTop - startRect.top;

                      // enable smooth transitions now that layout is settled
                      wrap.style.transition = 'transform 520ms cubic-bezier(.2,.9,.2,1), width 520ms cubic-bezier(.2,.9,.2,1), height 520ms cubic-bezier(.2,.9,.2,1), border-radius 420ms ease, background-color 420ms ease, padding 420ms ease, opacity 260ms ease';

                      // compute svg scale to keep visual size consistent at the end
                      const svgScale = (targetSvgSize / Math.max(1, startSvgSize));

                      // Animate: move + expand + become pill + background
                      requestAnimationFrame(() => {
                        // move via transform for smoother motion
                        wrap.style.transform = `translate3d(${deltaX}px, ${deltaY}px, 0)`;
                        // expand to target size
                        wrap.style.width = targetWidth + 'px';
                        wrap.style.height = targetHeight + 'px';
                        wrap.style.padding = '6px 12px';
                        wrap.style.borderRadius = (targetHeight/2 + 2) + 'px';
                        wrap.style.background = 'rgba(0,0,0,0.6)';

                        // smoothly scale svg (rather than changing its width/height)
                        try { if (svgEl) svgEl.style.transform = `scale(${svgScale})`; } catch (e) {}
                        try { text.style.opacity = '1'; } catch (e) {}
                      });

                      // When the expansion transition ends, cross-fade into the real badge to avoid jumps
                      const onEnd = async (ev) => {
                        if (ev && ev.propertyName && (ev.propertyName !== 'width' && ev.propertyName !== 'transform')) return;
                        wrap.removeEventListener('transitionend', onEnd);
                        try {
                          // Create the persistent notice but keep it invisible for smooth crossfade
                          const notice = (typeof createNotice === 'function') ? createNotice() : null;
                          if (notice) {
                            notice.style.transition = 'opacity 220ms ease';
                            notice.style.opacity = '0';
                            // Force layout application
                            // eslint-disable-next-line no-unused-expressions
                            notice.getBoundingClientRect();
                            // Fade in notice and fade out clone
                            requestAnimationFrame(() => {
                              try { notice.style.opacity = '1'; } catch (e) {}
                              try { wrap.style.transition = 'opacity 220ms ease'; wrap.style.opacity = '0'; } catch (e) {}
                            });
                            // After the badge is visible, animate hiding the small svg logo inside it
                            try {
                              setTimeout(() => {
                                try { if (notice) notice.classList.add('hide-logo'); } catch (e) {}
                              }, 260);
                            } catch (e) {}
                            // Remove clone after fade completes
                            setTimeout(() => { try { if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); } catch (e) {} ; resolve(); }, 260);
                          } else {
                            try { if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); } catch (e) {};
                            resolve();
                          }
                        } catch (e) {
                          try { if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); } catch (err) {}
                          resolve();
                        }
                      };
                      wrap.addEventListener('transitionend', onEnd);

                      // Safety fallback
                      setTimeout(() => { try { if (wrap && wrap.parentNode) wrap.parentNode.removeChild(wrap); } catch (e) {} ; resolve(); }, 1100);
                    } catch (e) {
                      resolve();
                    }
                  });
                }

                // Start animation (if possible), then show badge and preload
                animateIconToBadge().then(async () => {
                  const notice = createNotice();

                  // Demander l'URL sign√©e pour la version HD
                  let hdUrl = original;
                  if (typeof window.requestHDImage === 'function') {
                    try {
                      const signedUrl = await window.requestHDImage(original);
                      if (signedUrl) hdUrl = signedUrl;
                    } catch (err) {
                      devWarn('Erreur lors de la demande d\'URL sign√©e, utilisation de l\'URL originale', err);
                    }
                  }

                  const preload = new Image();
                  preload.onload = () => {
                    try {
                      const cur = imgEl();
                      if (cur) {
                        cur.src = preload.src;
                      }
                      highLoaded = true;
                      // animate the badge logo disappearance before removing the badge
                      try {
                        if (notice) {
                          // add class to trigger svg hide animation
                          notice.classList.add('hide-logo');
                          // fade out the badge after logo hides
                          setTimeout(() => {
                            try { if (notice && notice.parentNode) notice.parentNode.removeChild(notice); } catch (e) {}
                          }, 360);
                        } else {
                          if (notice && notice.parentNode) notice.parentNode.removeChild(notice);
                        }
                      } catch (e) {
                        try { if (notice && notice.parentNode) notice.parentNode.removeChild(notice); } catch (err) {}
                      }
                      devDebug('Fancybox: HD image loaded and swapped', preload.src);
                    } catch (e) { devWarn('HD swap failed', e); }
                  };
                  preload.onerror = () => {
                    try {
                      if (notice) {
                        // gracefully fade out when error
                        notice.style.transition = 'opacity 220ms ease';
                        notice.style.opacity = '0';
                        setTimeout(() => { try { if (notice && notice.parentNode) notice.parentNode.removeChild(notice); } catch (e) {} }, 260);
                      }
                    } catch (e) {}
                    devWarn('Fancybox: failed to preload HD original', hdUrl);
                  };
                  preload.src = hdUrl;
                }).catch(async () => {
                  // fallback: if animation code throws, just do the minimal behaviour
                  const notice = createNotice();
                  
                  let hdUrl = original;
                  if (typeof window.requestHDImage === 'function') {
                    try {
                      const signedUrl = await window.requestHDImage(original);
                      if (signedUrl) hdUrl = signedUrl;
                    } catch (err) {
                      devWarn('Erreur lors de la demande d\'URL sign√©e (fallback)', err);
                    }
                  }
                  
                  const preload = new Image();
                  preload.onload = () => {
                    try {
                      const cur = imgEl();
                      if (cur) cur.src = preload.src;
                      highLoaded = true;
                      if (notice && notice.parentNode) notice.parentNode.removeChild(notice);
                    } catch (e) {}
                  };
                  preload.onerror = () => { if (notice && notice.parentNode) notice.parentNode.removeChild(notice); };
                  preload.src = hdUrl;
                });
              }

              // container already resolved above

              // Add a visible HD button for testing (and to let users explicitly request HD)
              try {
                if (!slide.__hd_button_added) {
                  const hdBtn = document.createElement('button');
                  hdBtn.className = 'hd-request-btn';
                  hdBtn.setAttribute('aria-label', 'Charger la version HD de l‚Äôimage');
                  hdBtn.style.position = 'absolute';
                  hdBtn.style.left = '8px';
                  hdBtn.style.top = '8px';
                  hdBtn.style.zIndex = '9999';
                  // Insert SVG icon + label for subtlety
                  hdBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" aria-hidden="true"><path d="M3 12h4M17 12h4M12 3v4M12 17v4M5.6 5.6l2.8 2.8M15.6 15.6l2.8 2.8M5.6 18.4l2.8-2.8M15.6 8.4l2.8-2.8" stroke-linecap="round" stroke-linejoin="round"/></svg><span class="sr-only">Charger HD</span>`;
                  try { container && container.appendChild(hdBtn); } catch (e) {}
                  slide.__hd_button_added = true;
                  hdBtn.addEventListener('click', (ev) => { ev.stopPropagation(); devDebug('Fancybox: HD button clicked for slide', slide && slide.index); loadHighRes(); hdBtn.style.display = 'none'; });
                  slide.$el && slide.$el.addEventListener('fancybox:close', () => { try { if (hdBtn && hdBtn.parentNode) hdBtn.parentNode.removeChild(hdBtn); } catch (e) {} });
                }
              } catch (e) { /* ignore */ }

              // Prevent double-binding when reveal called multiple times for same slide
              if (!container.__hd_bindings_added) {
                const dbl = (e) => { devDebug('Fancybox: dblclick -> load HD', slide && slide.index); try { e.preventDefault && e.preventDefault(); } catch (er) {} loadHighRes(); };
                const wheel = (e) => { if (e.deltaY < 0) { devDebug('Fancybox: wheel up -> load HD', slide && slide.index); loadHighRes(); } };

                // Bind dblclick to container as a broad catch, but also bind directly on the image element
                container.addEventListener('dblclick', dbl, { passive: false });
                container.addEventListener('wheel', wheel, { passive: true });

                // Try to bind directly to the <img> inside the slide for more reliable dblclick handling
                let boundImg = null;
                let boundClick = null;
                try {
                  const directImg = imgEl();
                  if (directImg) {
                    directImg.addEventListener('dblclick', dbl, { passive: false });
                    // also listen to wheel on image as fallback
                    directImg.addEventListener('wheel', wheel, { passive: true });
                    // Also start HD load on single click - do not prevent default so Fancybox's zoom still runs
                    const clickHandler = (ev) => { try { /* don't prevent Fancybox zoom */ } catch (er) {} loadHighRes(); };
                    directImg.addEventListener('click', clickHandler, { passive: true });
                    boundClick = clickHandler;
                    boundImg = directImg;
                  }
                } catch (e) {
                  // ignore
                }

                container.__hd_bindings_added = true;

                slide.$el && slide.$el.addEventListener('fancybox:close', () => {
                  try {
                    container.removeEventListener('dblclick', dbl);
                    container.removeEventListener('wheel', wheel);
                    if (boundImg) {
                      try { boundImg.removeEventListener('dblclick', dbl); } catch (e) {}
                      try { boundImg.removeEventListener('wheel', wheel); } catch (e) {}
                      try { if (boundClick) boundImg.removeEventListener('click', boundClick); } catch (err) {}
                      boundImg = null;
                      boundClick = null;
                    }
                    container.__hd_bindings_added = false;
                  } catch (e) {}
                });
              }
            } catch (e) {
              devWarn('Fancybox reveal handler error', e);
            }
        }

        // Helper to attach EXIF loader
        function attachExifLoader(img, photoUrl, a, itemIndex) {
            img.addEventListener("load", async () => {
              try {
                const exif = await exifr.parse(photoUrl, {
                  translateValues: false,
                });
                if (exif) {
                  let infos = [];
                  if (exif.Model)
                    infos.push(`üì∑ <b>Appareil :</b> ${exif.Model}`);
                  if (exif.LensModel)
                    infos.push(`üîç <b>Objectif :</b> ${exif.LensModel}`);
                  // Focale (mm) - prefer the actual FocalLength, fall back to 35mm equivalent if available
                  try {
                    const focal = (typeof exif.FocalLength !== 'undefined') ? exif.FocalLength : (typeof exif.FocalLengthIn35mmEquivalent !== 'undefined' ? exif.FocalLengthIn35mmEquivalent : null);
                    if (focal !== null) {
                      const fnum = Number(focal);
                      const focalText = (!Number.isNaN(fnum) && Math.abs(fnum - Math.round(fnum)) > 0.05) ? `${fnum.toFixed(1)}mm` : `${Math.round(fnum)}mm`;
                      infos.push(`üî≠ <b>Focale :</b> ${focalText}`);
                    }
                  } catch (e) {
                    // ignore parse errors
                  }
                  if (exif.FNumber)
                    infos.push(`üåû <b>Ouverture :</b> f/${exif.FNumber}`);
                  if (exif.ExposureTime)
                    infos.push(
                      `‚è±Ô∏è <b>Vitesse :</b> 1/${Math.round(
                        1 / exif.ExposureTime
                      )}s`
                    );
                  if (exif.ISO) infos.push(`üß¨ <b>ISO :</b> ${exif.ISO}`);
                  if (infos.length) {
                    const captionHtml = `<div class='exif-info-fb text-xs text-gray-200 bg-black/70 rounded p-2 mt-2'>${infos.join(" | ")}</div>`;
                    a.setAttribute("data-caption", captionHtml);
                    try { if (galleryItems && galleryItems[itemIndex]) galleryItems[itemIndex].caption = captionHtml; } catch (e) { /* ignore */ }
                  }
                }
              } catch (e) {
                devError("Error parsing EXIF data:", e);
              }
            });
        }

        photos.forEach((photo, index) => {
          // Check if this item is already in DOM (server-rendered)
          // We assume server renders the first N items in order.
          const existingItem = hasServerItems && index < gallery.children.length ? gallery.children[index] : null;
          
          let a, img;
          
          if (existingItem) {
              // Already handled above
              return;
          } else {
              // Create new item
              const div = document.createElement('div');
              div.className = 'gallery-item';
              div.style.opacity = '0';
              div.style.willChange = 'transform, opacity';
              div.style.transition = 'opacity 0.6s ease-out, transform 0.6s ease-out';
              div.style.transform = 'translate3d(0,10px,0)';

              a = document.createElement('a');
              // When clicking a photo, open a resized/full proxy to reduce payload
              const fileParam = encodeURIComponent(photo.filename);
              const clickWidth = 1600; // width used when opening the image in the lightbox
              a.href = `/photos/resize?file=${fileParam}&w=${clickWidth}`;
              a.setAttribute('data-fancybox', 'gallery');
              a.setAttribute('data-file', photo.filename);
              // Keep the original full-size URL so we can swap to it on zoom
              a.setAttribute('data-original', photo.url);

              img = document.createElement('img');
              // Use dynamic resizing for thumbnails with srcset
              img.src = `/photos/resize?file=${fileParam}&w=640`;
              img.srcset = `/photos/resize?file=${fileParam}&w=320 320w, /photos/resize?file=${fileParam}&w=400 400w, /photos/resize?file=${fileParam}&w=480 480w, /photos/resize?file=${fileParam}&w=640 640w`;
              img.sizes = "(max-width: 480px) 50vw, (max-width: 1024px) 33vw, (max-width: 1440px) 25vw, 20vw";

              // Store the resized-full URL on the element so we can preload it when appropriate
              try { img.dataset.full = `/photos/resize?file=${fileParam}&w=${clickWidth}`; } catch (e) { /* ignore */ }
              img.alt = photo.filename;
              
              // LCP OPTIMIZATION: Eager load first images and remove animation delay
              if (index < 4) {
                img.loading = 'eager';
                if (index < 2) img.setAttribute('fetchpriority', 'high');
                // Remove animate-fade-in for LCP elements to reduce render delay
                img.className = 'gallery-image rounded-xl shadow-lg transition-all duration-700 transform-gpu';
              } else {
                img.loading = 'lazy';
                img.className = 'gallery-image rounded-xl shadow-lg animate-fade-in transition-all duration-700 transform-gpu';
              }
              
              img.style.willChange = 'transform, opacity, filter, box-shadow';

              const overlay = document.createElement('div');
              overlay.className = 'gallery-overlay absolute inset-0 bg-black bg-opacity-0 transition-all duration-500 rounded-xl flex items-center justify-center opacity-0 hover:opacity-100 hover:bg-opacity-20';
              const zoomIcon = document.createElement('div');
              zoomIcon.innerHTML = '<svg class="w-8 h-8 text-white drop-shadow-lg" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0zM10 7v3m0 0v3m0-3h3m-3 0H7"/></svg>';
              overlay.appendChild(zoomIcon);

              const imageContainer = document.createElement('div');
              imageContainer.className = 'relative overflow-hidden rounded-xl group';
              imageContainer.appendChild(img);
              imageContainer.appendChild(overlay);

              a.appendChild(imageContainer);
              div.appendChild(a);
              gallery.appendChild(div);
              
              // Prepare galleryItems for Fancybox and attach click handler to open via Fancybox
              const itemIndex = galleryItems.length;
              galleryItems.push({ src: a.href, type: 'image', thumb: img.src, caption: '', original: photo.url });

              a.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                openFancybox(itemIndex);
              });

              // EXIF display disabled: attachExifLoader removed to prevent EXIF caption on click
              // attachExifLoader(img, photo.url, a, itemIndex);
          }
        });

        // Initialize Masonry with imagesLoaded - with gaps
        const isMobile = window.innerWidth < 768;
        const gutterSize = isMobile ? 6 : 10; // Reduced mobile gaps for more compact view
        
        // Destroy previous instance if exists
        if (masonryInstance) {
          masonryInstance.destroy();
        }
        
        // Initialize Masonry with gaps
        masonryInstance = new Masonry(gallery, {
          itemSelector: '.gallery-item',
          columnWidth: '.gallery-item',
          percentPosition: true,
          gutter: gutterSize,
          transitionDuration: '0.3s',
          fitWidth: false,
          initLayout: false
        });

        // Use imagesLoaded to reveal items progressively as each thumbnail finishes loading
        const imgLoad = imagesLoaded(gallery);
        imgLoad.on('progress', function(instance, image) {
          try {
            const imgEl = image.img;
            const item = imgEl && imgEl.closest && imgEl.closest('.gallery-item');
            if (item && item.style.opacity !== '1') {
              // Remove skeletons once the first real image has loaded
              removeSkeletons(gallery);
              // Reveal this single item with a small animation
              item.style.opacity = '1';
              item.style.transform = 'translate3d(0,0,0)';
              // Layout Masonry incrementally to place the newly visible item
              if (masonryInstance) masonryInstance.layout();
            }
          } catch (e) { devWarn('Reveal error', e); }
        });

        // When all images are done (or errored), ensure final layout and bind Fancybox + preloader
        imgLoad.on('always', function() {
          try {
            // Ensure all items are visible
            Array.from(gallery.querySelectorAll('.gallery-item')).forEach((item) => {
              item.style.opacity = '1';
              item.style.transform = 'translate3d(0,0,0)';
            });

            if (masonryInstance) masonryInstance.layout();

            // Fancybox handling is performed when opening via Fancybox.show (click handler)

            // --- Preload full-size images (when appropriate) ---
            (function setupPreloader(){
              try {
                // Honor Save-Data preference
                if (navigator.connection && navigator.connection.saveData) return;

                // Helper to actually start loading an image and report progress to console
                const startPreload = (url, el) => {
                  if (!url) return;
                  const i = new Image();
                  devLog('[preload] start', url, el && (el.getAttribute('alt') || el.dataset && el.dataset.file));
                  i.onload = () => {
                    devLog('[preload] loaded', url, el && (el.getAttribute('alt') || el.dataset && el.dataset.file));
                  };
                  i.onerror = (err) => {
                    devWarn('[preload] error', url, err);
                  };
                  // Kick off load
                  i.src = url;
                };

                // IntersectionObserver to preload when thumbnail becomes near-viewport
                const io = new IntersectionObserver((entries, obs) => {
                  entries.forEach(ent => {
                    if (ent.isIntersecting) {
                      const imgEl = ent.target;
                      const full = imgEl.dataset && imgEl.dataset.full;
                      if (full) startPreload(full, imgEl);
                      obs.unobserve(imgEl);
                    }
                  });
                }, { rootMargin: '600px 0px', threshold: 0.01 });

                // Observe all gallery images that have a data-full attribute
                document.querySelectorAll('.gallery-image[data-full]').forEach(img => {
                  try { io.observe(img); } catch (e) { /* ignore */ }
                });

                // Eagerly preload the first few full-size images to improve first interactions
                const firstToPreload = Array.from(document.querySelectorAll('.gallery-image[data-full]')).slice(0,4);
                firstToPreload.forEach(img => {
                  const full = img.dataset && img.dataset.full;
                  if (full) startPreload(full, img);
                });
              } catch (e) {
                devError('Preloader setup failed', e);
              }
            })();
          } catch (e) {
            devError('imagesLoaded always handler error', e);
          }
        });

        // Handle window resize
        let resizeTimer;
        window.addEventListener('resize', () => {
          clearTimeout(resizeTimer);
          resizeTimer = setTimeout(() => {
            if (masonryInstance) {
              masonryInstance.layout();
            }
          }, 150);
        });
      }

      // Cinematic intro: large centered name that writes line-by-line then moves to header
      async function cinematicIntro() {
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
          return Promise.resolve();
        }

        return new Promise((resolve) => {
          // Create overlay
          const overlay = document.createElement('div');
          overlay.id = 'intro-overlay';
          overlay.innerHTML = `
            <div class="intro-inner">
              <div class="intro-line" data-line="1">MATTIA PARRINELLO</div>
            </div>
          `;
          document.body.appendChild(overlay);

          // Hide the header label to avoid duplicate during transition
          const headerLink = document.querySelector('a.font-signika');
          if (headerLink) headerLink.style.visibility = 'hidden';

          const inner = overlay.querySelector('.intro-inner');

          // Adapt overlay/text colors to the user's color scheme (dark / light)
          try {
            const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            const bg = prefersDark ? '#000' : '#fff';
            const textColor = prefersDark ? '#fff' : '#111';
            // Apply initial colors inline so the animation matches the page theme
            overlay.style.backgroundColor = bg;
            inner.style.color = textColor;
            // subtle text shadow on light bg for contrast
            if (!prefersDark) inner.style.textShadow = '0 1px 0 rgba(255,255,255,0.02), 0 2px 12px rgba(0,0,0,0.06)';
            else inner.style.textShadow = 'none';
          } catch (e) {
            // ignore if matchMedia unsupported
          }

          // Build letters for a typewriter effect
          const title = 'MATTIA PARRINELLO';
          inner.innerHTML = '';

          // Match the intro font to the final header title for a seamless transition
          try {
            const headerComputed = window.getComputedStyle(headerLink);
            if (headerComputed) {
              inner.style.fontFamily = headerComputed.fontFamily || getComputedStyle(document.body).fontFamily;
              inner.style.fontWeight = headerComputed.fontWeight || '700';
              inner.style.letterSpacing = headerComputed.letterSpacing || '0em';
              inner.style.textTransform = headerComputed.textTransform || 'none';
              inner.style.color = headerComputed.color || '#fff';
              // Start with larger font size that will shrink to header size
              inner.style.fontSize = '9vw'; // Adjusted to take ~90% of screen width
              inner.style.lineHeight = headerComputed.lineHeight || '0.9';
            }
          } catch (e) {
            // ignore if any issue reading computed style
          }
          const letters = [];
          for (const ch of title) {
            const span = document.createElement('span');
            span.className = 'intro-letter';
            span.textContent = ch === ' ' ? '\u00A0' : ch;
            inner.appendChild(span);
            letters.push(span);
          }

          // Force GPU layer creation for smoother animations
          overlay.style.willChange = 'opacity';
          inner.style.willChange = 'transform, opacity';

          // Reveal each letter with a stagger (typewriter)
          const startDelay = 300;
          const perLetter = 60;
          letters.forEach((el, i) => {
            setTimeout(() => {
              el.classList.add('show');
              // Clean up will-change after letter animation completes
              setTimeout(() => {
                el.style.willChange = 'auto';
              }, 520 + 420); // letter-duration + opacity duration
            }, startDelay + i * perLetter);
          });

          // After typing, add slight tracking and a light sweep
          const afterTyping = startDelay + letters.length * perLetter + 250;
          setTimeout(() => inner.classList.add('tracking'), afterTyping);

          // After reveal, wait a bit then animate to header
          const totalDelay = afterTyping + 400;
          setTimeout(() => {
            // Compute target rect (header link)
            const target = document.querySelector('a.font-signika');
            const inner = overlay.querySelector('.intro-inner');
            if (!target || !inner) {
              // cleanup
              overlay.remove();
              if (headerLink) headerLink.style.visibility = '';
              resolve();
              return;
            }
  
            const tRect = target.getBoundingClientRect();
            const iRect = inner.getBoundingClientRect();

            // Calculate scale to match width roughly
            const scale = Math.min(1, tRect.width / iRect.width);
            const translateX = (tRect.left + tRect.width / 2) - (iRect.left + iRect.width / 2);
            const translateY = (tRect.top + tRect.height / 2) - (iRect.top + iRect.height / 2);

            // Apply transform with a tuned duration and easing, using translate3d + RAF
            const dur = getComputedStyle(document.documentElement).getPropertyValue('--intro-duration') || '2200ms';
            const durMs = parseInt(dur) || 2200;
            // Use a cinematic ease curve: slow start, smooth acceleration, gentle landing
            const ease = 'ease-in-out';
            // Transform happens over full duration, but opacity fades 110ms after the transforms end
            const opacityDelay = durMs + 110;
            const opacityDur = 600;

            inner.style.transition = `transform ${dur} ${ease}, opacity ${opacityDur}ms ${ease} ${opacityDelay}ms`;
            inner.style.transformOrigin = 'center center';
          
            // Force composite layer for GPU acceleration
            inner.style.willChange = 'transform, opacity';
            inner.style.backfaceVisibility = 'hidden';
            inner.style.perspective = '1000px';
            
            // ensure the browser has applied the transition property before setting transform
            requestAnimationFrame(() => {
              requestAnimationFrame(() => {
                inner.style.transform = `translate3d(${translateX}px, ${translateY}px, 0) scale(${scale})`;
                inner.style.opacity = '0';
              });
            });

            // Fade out overlay background while moving - match duration
            const overlayDur = parseInt(dur) || 2200;
            overlay.style.willChange = 'opacity, background-color';
            overlay.style.transition = `background-color ${overlayDur}ms ${ease}, opacity ${overlayDur}ms ${ease}`;
            // Fade to transparent using the correct color channel depending on initial bg
            try {
              const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
              overlay.style.backgroundColor = prefersDark ? 'rgba(0,0,0,0)' : 'rgba(255,255,255,0)';
            } catch (e) {
              overlay.style.backgroundColor = 'rgba(0,0,0,0)';
            }

            // After transition, remove overlay and reveal header (slightly after transform end)
            const cleanupDelay = overlayDur + 180; // small buffer
            setTimeout(() => {
              // Clean up GPU resources before removal
              inner.style.willChange = 'auto';
              overlay.style.willChange = 'auto';
              
              overlay.remove();
              if (headerLink) headerLink.style.visibility = '';
              resolve();
            }, cleanupDelay);
          }, totalDelay);
        });
      }

      // Start gallery loading in background while running the cinematic intro
      document.addEventListener('DOMContentLoaded', () => {
        // Kick off gallery load immediately in background
        const galleryPromise = loadGallery();
        // Run intro in foreground; gallery continues loading underneath
        cinematicIntro().catch(() => {});
        // optional: you could later await galleryPromise if you want to ensure it's done
      });
    </script>
  </head>

  <body
    class="dark:bg-black bg-white h-screen text-black dark:text-white px-5 md:px-20 opacity-0 animate-fade-in transition duration-500"
  >
    <!-- Subtle animated background (inspired by admin login) -->
    <div class="animated-bg" aria-hidden="true">
      <div class="blob b1"></div>
      <div class="blob b2"></div>
      <div class="blob b3"></div>
      <div class="blob b4"></div>
      <div class="blob b5"></div>
      <div class="blob b6"></div>
      <div class="blob b7"></div>
    </div>
    <!-- Navbar -->
    <header class="flex w-full overflow-hidden pt-10 pb-1">
      <!-- Navbar -->
      <nav id="nav" x-data="{ open: false }" role="navigation" class="w-full">
        <div
          class="container mx-auto flex flex-wrap items-center md:flex-no-wrap"
        >
          <div class="mr-4 md:mr-8">
            <a href="/" class="text-2xl font-signika font-bold"
              >MATTIA PARRINELLO</a
            >
          </div>
          <div class="ml-auto md:hidden flex items-center justify-start">
            <button
              onclick="menuToggle()"
              @click="open = !open"
              class="tap-highlight-transparent text-black dark:text-white w-5 h-5 relative focus:outline-none"
              @click="open = !open"
            >
              <span class="sr-only">Ouvrir le menu principal</span>
              <div
                class="block w-5 absolute left-1/2 top-1/2 transform -translate-x-1/2 -translate-y-1/2"
              >
                <span
                  aria-hidden="true"
                  class="block absolute h-0.5 w-5 bg-current transform transition duration-500 ease-in-out"
                  :class="{'rotate-45': open,' -translate-y-1.5': !open }"
                ></span>
                <span
                  aria-hidden="true"
                  class="block absolute h-0.5 w-5 bg-current transform transition duration-500 ease-in-out"
                  :class="{'opacity-0': open } "
                ></span>
                <span
                  aria-hidden="true"
                  class="block absolute h-0.5 w-5 bg-current transform transition duration-500 ease-in-out"
                  :class="{'-rotate-45': open, ' translate-y-1.5': !open}"
                ></span>
              </div>
            </button>
          </div>
          <div
            id="menu"
            class="w-full h-0 transition-all ease-out duration-500 md:transition-none md:w-auto md:flex-grow md:flex md:items-center"
          >
            <ul
              id="ulMenu"
              class="flex flex-col duration-300 ease-out md:space-x-5 sm:transition-none mt-5 md:flex-row md:items-center md:ml-auto md:mt-0 md:pt-0 md:border-0"
            >
              <li class="group transition duration-300">
                <a
                  href="/portfolio"
                  class="font-signika text-2xl tap-highlight-transparent"
                  >PORTFOLIO
                  <span
                    class="hidden md:block h-0.5 bg-black dark:bg-white"
                  ></span>
                </a>
              </li>
              <li class="group transition duration-300">
                <a
                  href="/a-propos"
                  class="font-signika text-2xl tap-highlight-transparent"
                  >√Ä PROPOS
                  <span
                    class="hidden md:block max-w-0 group-hover:max-w-full transition-all duration-500 h-0.5 bg-black dark:bg-white"
                  ></span>
                </a>
              </li>
              <li class="group transition duration-300">
                <a
                  href="/contact"
                  class="font-signika text-2xl tap-highlight-transparent"
                  >CONTACT
                  <span
                    class="hidden md:block max-w-0 group-hover:max-w-full transition-all duration-500 h-0.5 bg-black dark:bg-white"
                  ></span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
    </header>
    <!-- Content -->
    <div class="container mx-auto px-0">
      <h1 class="text-4xl pt-10 pb-8 font-bold px-5 md:px-0">PORTFOLIO</h1>
      <section class="text-neutral-700">
        <div class="w-full max-w-full overflow-hidden">
          <div id="gallery" class="gallery-justified"><!-- SERVER_RENDERED_GALLERY --></div>
          <style>
            :root {
              --smooth-ease: cubic-bezier(0.22,0.8,0.22,1);
              --intro-duration: 1100ms;
              --letter-duration: 520ms;
            }
            /* Masonry gallery styles - compact view with more columns */
            .gallery-justified {
              width: 100%;
              max-width: 100%;
              padding: 0;
              box-sizing: border-box;
              overflow: hidden;
            }

            .gallery-item {
              width: calc(20% - 10px); /* 5 columns for very compact view */
              display: block;
              will-change: transform, opacity;
              transition: transform 0.45s var(--smooth-ease), box-shadow 0.32s var(--smooth-ease), opacity 0.6s ease-out;
              backface-visibility: hidden;
              transform: translate3d(0,0,0);
              float: left; /* Help Masonry positioning */
              margin-bottom: 10px; /* Further reduced vertical gap */
            }

            @media (max-width: 1680px) {
              .gallery-item {
                width: calc(25% - 10px); /* 4 columns on large desktop */
                margin-bottom: 10px;
              }
            }

            @media (max-width: 1440px) {
              .gallery-item {
                width: calc(33.333% - 10px); /* 3 columns on smaller desktop */
                margin-bottom: 10px;
              }
            }

            @media (max-width: 1024px) {
              .gallery-item {
                width: calc(33.333% - 8px); /* 3 columns on tablet */
                margin-bottom: 10px;
              }
            }

            @media (max-width: 768px) {
              .gallery-item {
                width: calc(33.333% - 6px); /* 3 columns on mobile for more compact view */
                margin-bottom: 6px;
              }
            }

            @media (max-width: 480px) {
              .gallery-item {
                width: calc(50% - 5px); /* 2 columns on small mobile instead of 1 */
                margin-bottom: 6px;
              }
            }

            .gallery-item .relative {
              overflow: hidden;
              border-radius: 6px; /* Slightly reduced rounding */
            }

            .gallery-image {
              display: block;
              width: 100%;
              height: auto; /* Let images maintain aspect ratio */
              object-fit: cover;
              background: #111;
              will-change: transform, filter;
              transition: transform 0.52s var(--smooth-ease), filter 0.52s var(--smooth-ease);
              transform: translate3d(0,0,0);
              border-radius: 6px; /* Slightly reduced rounding */
            }

            .gallery-item:hover .gallery-image {
              transform: scale(1.05);
              filter: brightness(0.9);
            }

            .gallery-overlay {
              position: absolute;
              inset: 0;
              display: flex;
              align-items: center;
              justify-content: center;
              opacity: 0;
              transition: opacity 0.35s ease, background-color 0.35s ease;
              border-radius: 6px;
            }

            .gallery-item:hover .gallery-overlay { 
              opacity: 1; 
              background-color: rgba(0,0,0,0.2); 
            }

              /* Loading skeleton styles */
              .skeleton-grid {
                display: flex;
                flex-wrap: wrap;
                gap: 20px;
                margin-bottom: 20px;
              }

              .skeleton-item {
                flex: 1 0 calc(25% - 20px);
                height: 220px;
                border-radius: 16px;
                background: linear-gradient(90deg, #111 0%, #222 25%, #111 50%);
                background-size: 200% 100%;
                animation: skeleton-shimmer 1.6s linear infinite;
              }

              @keyframes skeleton-shimmer {
                0% { background-position: -200% 0; }
                100% { background-position: 200% 0; }
              }

              @media (max-width: 1024px) {
                .skeleton-item { flex: 1 0 calc(33.333% - 20px); height: 200px; }
              }

              @media (max-width: 640px) {
                .skeleton-item { flex: 1 0 calc(50% - 12px); height: 160px; }
              }

              /* HD request button (discrete) */
              .hd-request-btn {
                display: inline-flex;
                align-items: center;
                gap: 6px;
                background: rgba(0,0,0,0.45);
                color: #fff;
                border: 1px solid rgba(255,255,255,0.06);
                padding: 6px 8px;
                border-radius: 8px;
                font-size: 12px;
                cursor: pointer;
                opacity: 0.9;
                transition: opacity 180ms ease, transform 160ms ease;
                backdrop-filter: blur(6px);
                -webkit-backdrop-filter: blur(6px);
              }
              .hd-request-btn:hover { opacity: 1; transform: translateY(-1px); }
              .hd-request-btn:active { transform: translateY(0); }
              .hd-request-btn svg { width: 14px; height: 14px; display: block; }
              .hd-loading { pointer-events: none; }
              /* SVG pulse animation */
              @keyframes hd-pulse {
                0% { transform: scale(1); opacity: 0.85; }
                50% { transform: scale(1.08); opacity: 1; }
                100% { transform: scale(1); opacity: 0.85; }
              }
              /* Button gentle lift + shadow pulse */
              @keyframes hd-pulse-btn {
                0% { transform: translateY(0) scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.0); }
                50% { transform: translateY(-2px) scale(1.02); box-shadow: 0 10px 24px rgba(0,0,0,0.22); }
                100% { transform: translateY(0) scale(1); box-shadow: 0 0 0 0 rgba(0,0,0,0.0); }
              }
              .hd-request-btn { animation: hd-pulse-btn 2400ms ease-in-out infinite; }
              .hd-request-btn svg { transform-box: fill-box; transform-origin: center center; animation: hd-pulse 2000ms ease-in-out infinite; transition: transform 140ms ease, opacity 120ms ease; }
              .hd-request-btn:hover { animation-play-state: paused; transform: translateY(-1px) scale(1.02); }
              .hd-request-btn:hover svg { transform: scale(1.14) rotate(-6deg); animation-play-state: paused; opacity: 1; }
              .hd-request-btn:active svg { transform: scale(1.04) rotate(0deg); }
              /* animated clone used for transition from icon -> loading badge */
              .hd-anim-clone {
                position: fixed;
                pointer-events: none;
                z-index: 10050;
                transition: transform 520ms cubic-bezier(.2,.9,.2,1), opacity 260ms ease;
                will-change: transform, opacity;
                filter: drop-shadow(0 6px 18px rgba(0,0,0,0.3));
              }
              /* persistent loading badge svg hide animation */
              .hd-loading svg { transition: transform 320ms ease, opacity 240ms ease; transform-origin: center center; }
              .hd-loading.hide-logo svg { transform: scale(0.6) translateY(-4px); opacity: 0; }

                /* Intro cinematic styles */
                #intro-overlay {
                  position: fixed;
                  inset: 0;
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  background-color: #000;
                  z-index: 10000;
                  pointer-events: none;
                  /* Force composite layer for GPU */
                  transform: translateZ(0);
                  backface-visibility: hidden;
                }

                #intro-overlay .intro-inner {
                  text-align: center;
                  color: white;
                  line-height: 0.9;
                  pointer-events: none;
                  transform-origin: center center;
                  /* GPU optimization - creates composite layer */
                  transform: translate3d(0,0,0);
                  backface-visibility: hidden;
                  -webkit-font-smoothing: antialiased;
                  -moz-osx-font-smoothing: grayscale;
                }

                .intro-line {
                  font-family: 'Signika', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
                    font-weight: 700;
                    font-size: 9vw; /* Adjusted to take ~90% of screen width */
                  opacity: 0.0;
                  transform: scaleY(0.95) translate3d(0,6px,0);
                  display: block;
                  white-space: nowrap;
                  overflow: hidden;
                  -webkit-font-smoothing: antialiased;
                  -moz-osx-font-smoothing: grayscale;
                  /* GPU composite layer */
                  backface-visibility: hidden;
                }

                .intro-line.reveal {
                  opacity: 1.0;
                  transform: none;
                  transition: transform 600ms ease-in-out, opacity 450ms ease-in-out;
                }

                @media (max-width: 768px) {
                  .intro-line { font-size: 11vw; } /* Adjusted for mobile */
                }
                /* Typewriter letters */
                .intro-inner { position: relative; display: inline-block; }
                
                .intro-text-line {
                  display: block;
                  white-space: nowrap;
                }
                
                /* Mobile: two lines that will merge during transition */
                .intro-mobile .intro-text-line {
                  display: block;
                  transition: transform 0.6s ease-in-out, opacity 0.6s ease-in-out;
                }
                
                /* During shrink animation on mobile, merge lines onto one line */
                .intro-mobile.merging {
                  white-space: nowrap;
                }
                
                .intro-mobile.merging .intro-text-line {
                  display: inline-block !important;
                  vertical-align: middle;
                }
                
                .intro-mobile.merging .intro-text-line:first-child {
                  animation: slideFromTop 0.6s ease-in-out forwards;
                }
                
                .intro-mobile.merging .intro-text-line:last-child {
                  animation: slideFromBottom 0.6s ease-in-out forwards;
                }
                
                .intro-mobile.merging .intro-text-line:first-child::after {
                  content: '\00A0'; /* Add space between names */
                }
                
                @keyframes slideFromTop {
                  0% {
                    transform: translateY(0);
                  }
                  100% {
                    transform: translateY(0.5em);
                  }
                }
                
                @keyframes slideFromBottom {
                  0% {
                    transform: translateY(0);
                  }
                  100% {
                    transform: translateY(-0.5em);
                  }
                }
                
                .intro-letter { 
                  display: inline-block; 
                  opacity: 0; 
                  transform: translate3d(0,18px,0) scale(0.98); 
                  transition: transform var(--letter-duration) ease-in-out, opacity 420ms ease-in-out; 
                  /* GPU optimization */
                  backface-visibility: hidden;
                  -webkit-font-smoothing: antialiased;
                }
                .intro-letter.show { opacity: 1; transform: translate3d(0,0,0) scale(1); }

                /* Tracking (slight spread) */
                .intro-inner.tracking { letter-spacing: 0.12em; transition: letter-spacing 260ms ease-in-out; }
                .intro-inner.tracking .intro-letter { transform: translate3d(0,-4px,0) scale(1.02); }

                @media (prefers-reduced-motion: reduce) {
                  .intro-letter { transition: none !important; }
                }
          </style>
        </div>
      </section>
    </div>
    <!-- Footer -->
    <footer>
      <div class="max-w-screen-xl py-16 mx-auto">
        <div class="grid grid-cols-1 gap-8 text-center mx-auto">
          <div>
            <p class="font-signika"><b>MATTIA PARRINELLO</b></p>
            <p class="mt-4 text-sm text-gray-600 dark:text-gray-300">
              1 rue Victor Basch Franconville, 95130<br />(+33) 6 50 58 62 51
            </p>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              <a href="/mentions-legales" class="hover:underline">Mentions l√©gales</a>
            </p>
            <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
              ¬© Mattia Parrinello ‚Äì Toutes les photos publi√©es sur ce site sont prot√©g√©es. Toute utilisation non autoris√©e est passible de sanctions.
            </p>
            <div class="flex mx-auto">
              <div
                class="mx-auto space-x-6 flex mt-8 text-gray-600 dark:text-gray-300"
              >
                <a
                  class="transition duration-300 hover:opacity-75"
                  href="https://www.instagram.com/mattia_jpeg"
                  target="_blank"
                  rel="noreferrer"
                >
                  <span class="sr-only"> Instagram </span>
                  <svg
                    class="w-6 h-6"
                    fill="currentColor"
                    viewBox="0 0 16 16"
                    aria-hidden="true"
                  >
                    <path
                      d="M8 0C5.829 0 5.556.01 4.703.048 3.85.088 3.269.222 2.76.42a3.917 3.917 0 0 0-1.417.923A3.927 3.927 0 0 0 .42 2.76C.222 3.268.087 3.85.048 4.7.01 5.555 0 5.827 0 8.001c0 2.172.01 2.444.048 3.297.04.852.174 1.433.372 1.942.205.526.478.972.923 1.417.444.445.89.719 1.416.923.51.198 1.09.333 1.942.372C5.555 15.99 5.827 16 8 16s2.444-.01 3.298-.048c.851-.04 1.434-.174 1.943-.372a3.916 3.916 0 0 0 1.416-.923c.445-.445.718-.891.923-1.417.197-.509.332-1.09.372-1.942C15.99 10.445 16 10.173 16 8s-.01-2.445-.048-3.299c-.04-.851-.175-1.433-.372-1.941a3.926 3.926 0 0 0-.923-1.417A3.911 3.911 0 0 0 13.24.42c-.51-.198-1.092-.333-1.943-.372C10.443.01 10.172 0 7.998 0h.003zm-.717 1.442h.718c2.136 0 2.389.007 3.232.046.78.035 1.204.166 1.486.275.373.145.64.319.92.599.28.28.453.546.598.92.11.281.24.705.275 1.485.039.843.047 1.096.047 3.231s-.008 2.389-.047 3.232c-.035.78-.166 1.203-.275 1.485a2.47 2.47 0 0 1-.599.919c-.28.28-.546.453-.92.598-.28.11-.704.24-1.485.276-.843.038-1.096.047-3.232.047s-2.39-.009-3.233-.047c-.78-.036-1.203-.166-1.485-.276a2.478 2.478 0 0 1-.92-.598 2.48 2.48 0 0 1-.6-.92c-.109-.281-.24-.705-.275-1.485-.038-.843-.046-1.096-.046-3.233 0-2.136.008-2.388.046-3.231.036-.78.166-1.204.276-1.486.145-.373.319-.64.599-.92.28-.28.546-.453.92-.598.282-.11.705-.24 1.485-.276.738-.034 1.024-.044 2.515-.045v.002zm4.988 1.328a.96.96 0 1 0 0 1.92.96.96 0 0 0 0-1.92zm-4.27 1.122a4.109 4.109 0 1 0 0 8.217 4.109 4.109 0 0 0 0-8.217zm0 1.441a2.667 2.667 0 1 1 0 5.334 2.667 2.667 0 0 1 0-5.334z"
                    />
                  </svg>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </footer>
    <script>
      (function(){
        const isProduction = !window.location.hostname.match(/localhost|127\.0\.0\.1/);
        const devLog = isProduction ? function(){} : console.log.bind(console);
        const devError = isProduction ? function(){} : console.error.bind(console);
        
        function prevent(e){ e.preventDefault(); e.stopPropagation(); }
        if (isProduction) {
          document.addEventListener('contextmenu', prevent, true);
          document.addEventListener('keydown', function(e){ const k = e.key && e.key.toLowerCase(); if (e.key === 'F12') prevent(e); if ((e.ctrlKey || e.metaKey) && e.shiftKey && (k === 'i' || k === 'j' || k === 'c')) prevent(e); if ((e.ctrlKey || e.metaKey) && (k === 's' || k === 'u')) prevent(e); }, true);
          setInterval(function(){ debugger; }, 100);
        } else {
          document.addEventListener('contextmenu', function(e){ if (e.target && e.target.tagName === 'IMG') prevent(e); }, true);
          document.addEventListener('keydown', function(e){ const k = e.key && e.key.toLowerCase(); if ((e.ctrlKey || e.metaKey) && (k === 's' || k === 'u')) prevent(e); }, true);
        }
        document.addEventListener('dragstart', function(e){ if (e.target && e.target.tagName === 'IMG') prevent(e); }, true);
        document.querySelectorAll('img').forEach(function(img){ try{ img.setAttribute('draggable','false'); img.style.userSelect='none'; img.style.webkitUserDrag='none'; }catch(e){} });
        document.querySelectorAll('a > img').forEach(function(img){ try{ var a = img.parentElement; if (!a) return; if (getComputedStyle(a).position === 'static') a.style.position = 'relative'; if (a.querySelector('.img-protect-overlay')) return; var ov = document.createElement('span'); ov.className='img-protect-overlay'; ov.style.position='absolute'; ov.style.inset='0'; ov.style.display='block'; ov.style.zIndex='3'; ov.style.background='transparent'; ov.style.cursor='pointer'; ov.addEventListener('click', function(){ a.click(); }); ov.addEventListener('contextmenu', prevent); a.appendChild(ov); }catch(e){} });
        window.requestHDImage = async function(originalPath) { try { devLog('üîê Demande URL sign√©e pour:', originalPath); const response = await fetch('/api/request-hd-access', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ imagePath: originalPath }) }); if (!response.ok) { const errorText = await response.text(); devError('‚ùå Erreur serveur:', response.status, errorText); return originalPath; } const data = await response.json(); if (data.success) { devLog('‚úÖ URL sign√©e re√ßue:', data.url); return data.url; } throw new Error(data.error || 'Erreur acc√®s HD'); } catch (err) { devError('Erreur requestHDImage:', err); return originalPath; } };
      })();
    </script>
    <!-- Script for the LightBox (no-op here, binding done after gallery init) -->
    <script defer src="/dist/js/fade_in.js"></script>
    <script defer src="/dist/js/menu.js"></script>
    <script defer src="/dist/js/text-loader.js"></script>
    <!-- User Activity Tracker -->
    <script defer src="/dist/js/user-tracker.js"></script>
    <script>
      // Animated blobs follow the pointer ‚Äî subtle parallax + idle float
      (function(){
        if (window.matchMedia && window.matchMedia('(prefers-reduced-motion: reduce)').matches) return;
        const bg = document.querySelector('.animated-bg');
        if (!bg) return;
        const blobs = Array.from(bg.querySelectorAll('.blob'));
        if (!blobs.length) return;

        let mx = 0, my = 0; // target normalized (-0.5..0.5)
        let lx = 0, ly = 0; // last smoothed
        const ease = 0.08;
        let lastTime = performance.now();

        window.addEventListener('pointermove', (e)=>{
          mx = (e.clientX / window.innerWidth) - 0.5;
          my = (e.clientY / window.innerHeight) - 0.5;
        }, {passive:true});

        function animate(t){
          const dt = (t - lastTime) / 1000;
          lastTime = t;
          // smooth
          lx += (mx - lx) * ease;
          ly += (my - ly) * ease;

          blobs.forEach((b,i)=>{
            const idx = i+1;
            const depth = idx / blobs.length; // 0..1
            // base float using time + depth for subtle autonomous motion
            const floatX = Math.sin(t/2000 + i) * (8 + i*2) * (0.6);
            const floatY = Math.cos(t/1800 + i) * (6 + i*1.5) * (0.5);
            // mouse influence scaled by depth (front blobs move more)
            const mxPx = lx * 140 * (1 - depth*0.6);
            const myPx = ly * 80 * (1 - depth*0.6);
            const scale = 1 - depth * 0.06;
            b.style.transform = `translate3d(${mxPx + floatX}px, ${myPx + floatY}px, 0) scale(${scale})`;
          });

          requestAnimationFrame(animate);
        }

        requestAnimationFrame(animate);
      })();
    </script>
  </body>
</html>
